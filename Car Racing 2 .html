<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Car Racing ¬∑ Gold & Skins</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(45deg, #0a1f2e, #102b3f);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        .game-container {
            position: relative;
            width: 400px;
            height: 600px;
            border-radius: 24px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.7), 0 0 0 2px #4f9fff inset;
            overflow: hidden;
            background: #1a2e3b;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background-color: #1e3a4a;
            image-rendering: crisp-edges;
        }

        .menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(8, 20, 30, 0.9);
            backdrop-filter: blur(4px);
            z-index: 10;
            transition: opacity 0.2s;
            padding: 20px;
            text-align: center;
            border-radius: 24px;
            overflow-y: auto;
        }

        .menu-overlay.hidden {
            display: none;
        }

        h1, h2, h3 {
            margin: 0 0 12px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 4px 0 #0a141c;
        }

        h1 {
            color: #ffcf4a;
            font-size: 2.8rem;
            line-height: 1;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px #f0b000);
        }

        h2 {
            color: #ffaa2b;
            font-size: 2.2rem;
        }

        h3 {
            color: #7abfff;
            font-size: 1.8rem;
            margin-top: 5px;
        }

        .menu-button {
            background: #ffb347;
            border: none;
            border-bottom: 5px solid #a55d1a;
            color: #1b2b38;
            font-weight: bold;
            font-size: 1.4rem;
            padding: 10px 28px;
            margin: 8px 0;
            border-radius: 60px;
            width: 220px;
            cursor: pointer;
            box-shadow: 0 8px 0 #6a3c0e, 0 10px 20px black;
            transition: 0.07s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .menu-button.small {
            font-size: 1.2rem;
            padding: 8px 16px;
            width: 160px;
        }

        .menu-button:active {
            transform: translateY(6px);
            border-bottom-width: 2px;
            box-shadow: 0 4px 0 #6a3c0e, 0 10px 20px black;
        }

        .info-text {
            color: #b3e4ff;
            font-size: 1rem;
            margin: 10px 0 5px;
            background: rgba(0, 20, 30, 0.6);
            padding: 8px 16px;
            border-radius: 40px;
            border: 1px solid #3f9eff;
        }

        .gameover-score {
            font-size: 2.2rem;
            font-weight: 800;
            background: #0e2a36;
            color: #ffd966;
            padding: 8px 30px;
            border-radius: 80px;
            margin: 15px 0;
            border: 2px solid #f9b81b;
            box-shadow: inset 0 -3px 0 #886633;
        }

        .gold-display {
            background: #2f4d2f;
            color: #ffd966;
            font-size: 1.8rem;
            font-weight: bold;
            padding: 8px 30px;
            border-radius: 40px;
            border: 2px solid #d4af37;
            margin: 10px 0;
            display: inline-block;
            box-shadow: inset 0 -3px 0 #3f6a3f;
        }

        .skin-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px 10px;
            margin: 10px 0;
            background: #10262e;
            border-radius: 30px;
            border: 1px solid #2c6c8f;
        }

        .skin-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1e4050;
            border-radius: 40px;
            padding: 8px 16px;
            color: white;
            border: 2px solid #2f7a9e;
            box-shadow: 0 4px 0 #0a1e28;
        }

        .skin-color-preview {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-right: 10px;
            border: 2px solid white;
        }

        .skin-info {
            flex: 1;
            text-align: left;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .skin-price {
            font-size: 1.4rem;
            color: #ffd966;
            margin-right: 10px;
        }

        .skin-action {
            background: #f0b85b;
            border: none;
            border-bottom: 4px solid #936f2b;
            padding: 6px 14px;
            border-radius: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.05s;
            color: #1e2e3a;
        }

        .skin-action:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
        }

        .skin-action:disabled {
            opacity: 0.4;
            transform: none;
            pointer-events: none;
        }

        .controls {
            color: #aaccff;
            font-size: 1rem;
            margin-top: 15px;
            background: #102a33;
            padding: 6px 16px;
            border-radius: 40px;
            border: 1px solid #3c89b0;
        }

        .row {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
<div class="game-container">
    <canvas id="gameCanvas" width="400" height="600"></canvas>

    <!-- MAIN MENU -->
    <div id="mainMenu" class="menu-overlay">
        <h1>üèÅ RACING<br>2D</h1>
        <div class="gold-display" id="mainMenuGold">üí∞ 0</div>
        <button class="menu-button" id="startGameBtn">START RACE</button>
        <button class="menu-button" id="shopFromMainBtn">SHOP </button>
        <div class="controls">‚Üê ‚Üí move | <b>S</b> pause</div>
        <div class="info-text">Overtake cars ¬∑ earn gold</div>
    </div>

    <!-- PAUSE MENU -->
    <div id="pauseMenu" class="menu-overlay hidden">
        <h2>‚è∏ PAUSED</h2>
        <div class="gold-display" id="pauseGold">üí∞ 0</div>
        <button class="menu-button small" id="resumeGameBtn">RESUME</button>
        <button class="menu-button small" id="restartFromPauseBtn">RESTART</button>
        <button class="menu-button small" id="shopFromPauseBtn">SHOP</button>
        <button class="menu-button small" id="mainMenuFromPauseBtn">MAIN MENU</button>
        <div class="controls">press <b>S</b> again to resume</div>
    </div>

    <!-- SHOP MENU -->
    <div id="shopMenu" class="menu-overlay hidden">
        <h2>CAR SHOP</h2>
        <div class="gold-display" id="shopGold">üí∞ 0</div>
        <div class="skin-grid" id="skinContainer"></div>
        <div class="row">
            <button class="menu-button small" id="backFromShopBtn">BACK</button>
        </div>
    </div>

    <!-- GAME OVER MENU -->
    <div id="gameOverMenu" class="menu-overlay hidden">
        <h2>GAME OVER</h2>
        <div id="gameOverScoreDisplay" class="gameover-score">0</div>
        <button class="menu-button small" id="restartGameBtn">RESTART</button>
        <button class="menu-button small" id="backToMainBtn">MAIN MENU</button>
    </div>
</div>

<script>
    (function() {
        // ----- CANVAS & CONTEXT -----
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ----- MENU ELEMENTS -----
        const mainMenuDiv = document.getElementById('mainMenu');
        const pauseMenuDiv = document.getElementById('pauseMenu');
        const shopMenuDiv = document.getElementById('shopMenu');
        const gameOverDiv = document.getElementById('gameOverMenu');
        const gameOverScoreSpan = document.getElementById('gameOverScoreDisplay');

        // Gold displays
        const mainMenuGold = document.getElementById('mainMenuGold');
        const pauseGold = document.getElementById('pauseGold');
        const shopGold = document.getElementById('shopGold');

        // Buttons
        const startBtn = document.getElementById('startGameBtn');
        const shopFromMain = document.getElementById('shopFromMainBtn');
        const resumeBtn = document.getElementById('resumeGameBtn');
        const restartFromPause = document.getElementById('restartFromPauseBtn');
        const shopFromPause = document.getElementById('shopFromPauseBtn');
        const mainMenuFromPause = document.getElementById('mainMenuFromPauseBtn');
        const backFromShop = document.getElementById('backFromShopBtn');
        const restartBtn = document.getElementById('restartGameBtn');
        const backToMainBtn = document.getElementById('backToMainBtn');

        // Skin container
        const skinContainer = document.getElementById('skinContainer');

        // ----- GLOBAL STATE -----
        let gameActive = false;
        let paused = false;
        let animationFrame = null;

        // ----- PLAYER & GAME VARIABLES -----
        const player = {
            x: 185, y: 520, w: 30, h: 52
        };

        let opponents = [];
        let score = 0;
        let gold = 0;                // persistent currency
        let currentSpeed = 4.5;
        let spawnCounter = 0;
        const BASE_SPAWN_INTERVAL = 40;
        let spawnInterval = BASE_SPAWN_INTERVAL;

        const trackLeft = 50, trackRight = 350;
        const minCarX = trackLeft, maxCarX = trackRight - player.w;

        // keyboard flags
        let leftPressed = false, rightPressed = false;

        // ----- SKINS SYSTEM -----
        const skins = [
            { name: 'Red Flame', color: '#e63e3e', price: 0, unlocked: true },
            { name: 'Blue Thunder', color: '#3e6ee6', price: 50, unlocked: false },
            { name: 'Green Machine', color: '#3ee63e', price: 100, unlocked: false },
            { name: 'Black Knight', color: '#2e2e2e', price: 200, unlocked: false },
            { name: 'Golden Arrow', color: '#e6b800', price: 350, unlocked: false }  // rare skin
        ];
        let selectedSkinIndex = 0;    // red default

        // ----- HELPER FUNCTIONS -----
        function updateGoldDisplay() {
            mainMenuGold.innerText = `üí∞ ${gold}`;
            pauseGold.innerText = `üí∞ ${gold}`;
            shopGold.innerText = `üí∞ ${gold}`;
        }

        // spawn opponent with random type: normal (blue) or rare (gold)
        function spawnOpponent() {
            const carWidth = 30, carHeight = 52;
            const randomX = Math.floor(Math.random() * (trackRight - carWidth - trackLeft + 1)) + trackLeft;
            const isRare = Math.random() < 0.2; // 20% rare (gold car)
            opponents.push({
                x: randomX,
                y: -carHeight - Math.random() * 40,
                w: carWidth,
                h: carHeight,
                type: isRare ? 'rare' : 'normal'
            });
        }

        function updateDifficulty() {
            currentSpeed = Math.min(8.5, 4.5 + Math.floor(score / 6));
            spawnInterval = Math.max(20, BASE_SPAWN_INTERVAL - Math.floor(score / 2.5));
        }

        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.w &&
                   rect1.x + rect1.w > rect2.x &&
                   rect1.y < rect2.y + rect2.h &&
                   rect1.y + rect1.h > rect2.y;
        }

        function resetGame() {
            player.x = 185;
            opponents = [];
            score = 0;
            currentSpeed = 4.5;
            spawnCounter = 0;
            spawnInterval = BASE_SPAWN_INTERVAL;
            leftPressed = false;
            rightPressed = false;
            paused = false;           // ensure pause off
            pauseMenuDiv.classList.add('hidden');
        }

        function triggerGameOver() {
            if (!gameActive) return;
            gameActive = false;
            paused = false;
            pauseMenuDiv.classList.add('hidden');
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            gameOverScoreSpan.innerText = score;
            gameOverDiv.classList.remove('hidden');
        }

        function showMainMenu() {
            gameActive = false;
            paused = false;
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            // Hide all other overlays
            pauseMenuDiv.classList.add('hidden');
            gameOverDiv.classList.add('hidden');
            shopMenuDiv.classList.add('hidden');
            mainMenuDiv.classList.remove('hidden');
            updateGoldDisplay();
        }

        // start / resume game
        function startGame() {
            mainMenuDiv.classList.add('hidden');
            gameOverDiv.classList.add('hidden');
            pauseMenuDiv.classList.add('hidden');
            shopMenuDiv.classList.add('hidden');

            if (!gameActive) {
                resetGame();  // fresh start
                gameActive = true;
                paused = false;
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    animationFrame = null;
                }
                animationFrame = requestAnimationFrame(gameLoop);
            } else {
                // just resume from pause
                paused = false;
                pauseMenuDiv.classList.add('hidden');
            }
        }

        // pause toggle
        function togglePause() {
            if (!gameActive) return;
            paused = !paused;
            if (paused) {
                pauseMenuDiv.classList.remove('hidden');
                updateGoldDisplay();
            } else {
                pauseMenuDiv.classList.add('hidden');
            }
        }

        // shop handling
        function openShop(previousMenu) {
            // previous can be 'main' or 'pause'
            // store a data attribute to know where to return
            shopMenuDiv.dataset.previous = previousMenu;
            // hide current menu
            if (previousMenu === 'main') mainMenuDiv.classList.add('hidden');
            else if (previousMenu === 'pause') pauseMenuDiv.classList.add('hidden');
            // show shop
            shopMenuDiv.classList.remove('hidden');
            renderShop();
            updateGoldDisplay();
        }

        function closeShop() {
            const prev = shopMenuDiv.dataset.previous;
            shopMenuDiv.classList.add('hidden');
            if (prev === 'main') mainMenuDiv.classList.remove('hidden');
            else if (prev === 'pause') pauseMenuDiv.classList.remove('hidden');
        }

        function renderShop() {
            let html = '';
            skins.forEach((skin, index) => {
                const isOwned = skin.unlocked;
                const isSelected = (index === selectedSkinIndex);
                html += `<div class="skin-item">
                    <div class="skin-color-preview" style="background: ${skin.color};"></div>
                    <div class="skin-info">${skin.name}</div>
                    <div class="skin-price">${skin.price}üí∞</div>
                    ${!isOwned ? 
                        `<button class="skin-action" data-skin-index="${index}" data-action="buy">BUY</button>` : 
                        (isSelected ? 
                            '<button class="skin-action" disabled>USED</button>' : 
                            `<button class="skin-action" data-skin-index="${index}" data-action="select">SELECT</button>`)
                    }
                </div>`;
            });
            skinContainer.innerHTML = html;

            // Attach event listeners to dynamically created buttons
            document.querySelectorAll('.skin-action[data-action="buy"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = e.target.dataset.skinIndex;
                    buySkin(parseInt(idx));
                });
            });
            document.querySelectorAll('.skin-action[data-action="select"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = e.target.dataset.skinIndex;
                    selectSkin(parseInt(idx));
                });
            });
        }

        function buySkin(index) {
            const skin = skins[index];
            if (skin.unlocked) return;
            if (gold >= skin.price) {
                gold -= skin.price;
                skin.unlocked = true;
                updateGoldDisplay();
                renderShop(); // re-render
            } else {
                alert('Not enough gold!');
            }
        }

        function selectSkin(index) {
            if (skins[index].unlocked) {
                selectedSkinIndex = index;
                renderShop();
            }
        }

        // ----- GAME LOOP -----
        function gameLoop() {
            if (!gameActive) return;

            if (!paused) {
                // update difficulty based on score
                updateDifficulty();

                // move opponents
                for (let i = 0; i < opponents.length; i++) {
                    opponents[i].y += currentSpeed;
                }

                // spawn new cars
                spawnCounter++;
                if (spawnCounter >= spawnInterval) {
                    spawnOpponent();
                    spawnCounter = 0;
                }

                // remove off-screen opponents & add gold
                for (let i = opponents.length - 1; i >= 0; i--) {
                    if (opponents[i].y > canvas.height) {
                        const opp = opponents[i];
                        if (opp.type === 'rare') {
                            gold += 5;
                        } else {
                            gold += 1;
                        }
                        opponents.splice(i, 1);
                        score += 1;
                    }
                }

                // player movement
                if (leftPressed) {
                    player.x = Math.max(minCarX, player.x - 6);
                }
                if (rightPressed) {
                    player.x = Math.min(maxCarX, player.x + 6);
                }

                // collision detection
                for (let opp of opponents) {
                    if (checkCollision(player, opp)) {
                        triggerGameOver();
                        return;
                    }
                }
            }

            // draw scene (always draw, even when paused)
            drawScene();

            // request next frame
            animationFrame = requestAnimationFrame(gameLoop);
        }

        // ----- DRAWING (with skin support) -----
        function drawScene() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // road background
            ctx.fillStyle = '#2a4a5a';
            ctx.fillRect(trackLeft-5, 0, trackRight-trackLeft+10, canvas.height);
            ctx.fillStyle = '#1f3f4d';
            ctx.fillRect(trackLeft, 0, trackRight-trackLeft, canvas.height);

            // lane markings
            ctx.strokeStyle = '#e8e8c9';
            ctx.lineWidth = 5;
            ctx.setLineDash([20, 30]);
            ctx.beginPath();
            ctx.moveTo(trackLeft + (trackRight-trackLeft)/2, 0);
            ctx.lineTo(trackLeft + (trackRight-trackLeft)/2, canvas.height);
            ctx.stroke();

            ctx.setLineDash([]);
            ctx.strokeStyle = '#9ec3c0';
            ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(trackLeft-2, 0); ctx.lineTo(trackLeft-2, canvas.height); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(trackRight+2, 0); ctx.lineTo(trackRight+2, canvas.height); ctx.stroke();

            ctx.strokeStyle = '#7f9faa';
            ctx.lineWidth = 2;
            ctx.setLineDash([6, 14]);
            ctx.beginPath(); ctx.moveTo(trackLeft-10, 0); ctx.lineTo(trackLeft-10, canvas.height); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(trackRight+10, 0); ctx.lineTo(trackRight+10, canvas.height); ctx.stroke();
            ctx.setLineDash([]);

            // draw opponent cars (with type)
            for (let opp of opponents) {
                if (opp.type === 'rare') {
                    ctx.fillStyle = '#e6b800'; // gold
                } else {
                    ctx.fillStyle = '#2b95d9'; // normal blue
                }
                ctx.fillRect(opp.x, opp.y, opp.w, opp.h);
                // windows (common for both)
                ctx.fillStyle = '#c1e2ff';
                ctx.fillRect(opp.x+4, opp.y+6, opp.w-8, 14);
                ctx.fillStyle = '#467a9e';
                ctx.fillRect(opp.x+6, opp.y+26, opp.w-12, 12);
                // headlights
                ctx.fillStyle = '#f5e56b';
                ctx.fillRect(opp.x+2, opp.y+opp.h-8, 6, 4);
                ctx.fillRect(opp.x+opp.w-8, opp.y+opp.h-8, 6, 4);
            }

            // draw player car with selected skin
            const skinColor = skins[selectedSkinIndex].color;
            ctx.fillStyle = skinColor;
            ctx.fillRect(player.x, player.y, player.w, player.h);
            ctx.fillStyle = '#3d1f1f';
            ctx.fillRect(player.x+5, player.y+8, player.w-10, 14);
            ctx.fillStyle = '#b57a7a';
            ctx.fillRect(player.x+8, player.y+30, player.w-16, 10);
            ctx.fillStyle = '#ffd966';
            ctx.fillRect(player.x+3, player.y+player.h-10, 6, 5);
            ctx.fillRect(player.x+player.w-9, player.y+player.h-10, 6, 5);
            ctx.fillStyle = '#a02020';
            ctx.fillRect(player.x+8, player.y+44, 5, 5);
            ctx.fillRect(player.x+17, player.y+44, 5, 5);

            // HUD: score, gold, speed
            ctx.font = 'bold 22px "Segoe UI", monospace';
            ctx.fillStyle = '#f0f9ff';
            ctx.shadowColor = '#0a3040';
            ctx.shadowBlur = 8;
            ctx.fillText(`‚ö°${score}`, 280, 70);
            ctx.fillText(`üí∞${gold}`, 40, 70);
            ctx.font = 'bold 16px monospace';
            ctx.fillStyle = '#fdd998';
            ctx.fillText(`km/h ${Math.floor(currentSpeed*15)}`, 260, 120);
            ctx.shadowBlur = 0;
        }

        // ----- KEYBOARD -----
        function handleKeyDown(e) {
            const key = e.key;
            if (key === 'ArrowLeft' || key === 'ArrowRight' || key === 's' || key === 'S') {
                e.preventDefault();
            }

            // S key toggles pause (only if game active and not in menu)
            if ((key === 's' || key === 'S') && gameActive && !shopMenuDiv.classList.contains('hidden') === false) {
                togglePause();
                return;
            }

            if (!gameActive || paused) return; // ignore arrows if paused or game not active

            if (key === 'ArrowLeft') {
                leftPressed = true;
            } else if (key === 'ArrowRight') {
                rightPressed = true;
            }
        }

        function handleKeyUp(e) {
            const key = e.key;
            if (key === 'ArrowLeft' || key === 'ArrowRight' || key === 's' || key === 'S') {
                e.preventDefault();
            }
            if (key === 'ArrowLeft') {
                leftPressed = false;
            } else if (key === 'ArrowRight') {
                rightPressed = false;
            }
        }

        window.addEventListener('keydown', handleKeyDown);
        window.addEventListener('keyup', handleKeyUp);

        // ----- BUTTON HANDLERS -----
        startBtn.addEventListener('click', () => startGame());

        shopFromMain.addEventListener('click', () => openShop('main'));

        resumeBtn.addEventListener('click', () => {
            paused = false;
            pauseMenuDiv.classList.add('hidden');
        });

        restartFromPause.addEventListener('click', () => {
            // restart from pause: reset, then start game (which hides pause)
            resetGame();
            startGame(); // this will set gameActive = true, paused false, hide menus
        });

        shopFromPause.addEventListener('click', () => openShop('pause'));

        mainMenuFromPause.addEventListener('click', () => {
            gameActive = false;
            paused = false;
            if (animationFrame) cancelAnimationFrame(animationFrame);
            showMainMenu();
        });

        backFromShop.addEventListener('click', closeShop);

        restartBtn.addEventListener('click', () => {
            resetGame();
            startGame();
        });

        backToMainBtn.addEventListener('click', showMainMenu);

        // also handle overlay closing if click on canvas? not needed

        // initial reset and draw
        resetGame();
        updateGoldDisplay();
        drawScene(); // static road
    })();
</script>
</body>
</html>